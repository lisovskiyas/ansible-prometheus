---
- name: Setup node-exporter service
  hosts: my_server
  vars:
    version: 1.7.0
  gather_facts: no

  tasks:
    - name: install wget package
      apt:
        name: wget
        state: latest
        update_cache: yes
      become: yes

    - name: download node exporter
      command: wget https://github.com/prometheus/node_exporter/releases/download/v{{version}}/node_exporter-{{version}}.linux-amd64.tar.gz

    - name: extract node exporter archieve
      command: tar xvfz node_exporter-{{version}}.linux-amd64.tar.gz

    - name: mv node-exporter to /usr/local/bin
      command: mv node_exporter-{{version}}.linux-amd64/node_exporter /usr/local/bin/
      become: yes

    - name: Create node_exporter user
      user:
        name: node_exporter
        system: yes
        create_home: no
        shell: /bin/false
      become: yes

    - name: copy node_exporter.service file to /etc/systemd/system
      copy:
        src: ./node_exporter.service
        dest: /etc/systemd/system/node_exporter.service
        mode: '0644'
      become: yes

    - name: reload systemd configuration
      command: systemctl daemon-reload
      become: yes

    - name: start node exporter service
      systemd:
        name: node_exporter
        state: started
        enabled: yes
      become: yes